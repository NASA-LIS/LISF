DESCRIPTION OF SCRIPTS

Eric Kemp/SSAI
Last updated 3 Nov 2021

There are 8u scripts that collectively generate metrics (anomalies and
standardized anomalies) for LIS S2S forecasts, generated by one or more NMME
models for 9 months. These scripts will read in monthly CF-1.8 netCDF files
for forecasts and hindcasts generated by the s2spost scripts; produce
preliminary netCDF output files; produce supplemental netCDF files in CF-1.8
convention; copy multiple metrics fields into common files; and finally
product GeoTIFF files with ensemble medians of the metrics.

A batch job script is included to automate processing of sets of metrics.

The scripts use the netCDF Operators (NC) software, the Climate Data Operators
(CDO) software, the UNIDATA Python NetCDF4 library package, and the Xarray
Python package.

Early versions of some of these scripts were developed by Shrad Shukla/UCSB,
and further modified by Abheera Hazra/UMD.

These scripts were developed for use on the NASA Discover supercomper.  Change
will be needed to run run_generate_metrics.sh if porting to a different
machine.  Paths to NCO, CDO, and the module environment for the Python packages
will also need to be updated.

In addition, a configuration file (s2smetric.cfg) exists to store useful
settings, including paths on the local system.

The scripts are:

postprocess_nmme_job.py:
        run_generate_metrics.sh <- Batch job script
                lib_bcsd_metrics/convert_dyn_fcst_to_anom.py:
                lib_bcsd_metrics/convert_dyn_fcst_to_sanom.py:
                        lib_bcsd_metrics/metricslib.py
        convert_s2s_anom_cf.py
        merge_s2s_anom_cf.py
        make_s2s_median_metric_geotiff.py

postprocess_nmme_job.py is the overall driver.  It will break up the processing
into multiple jobs, each handling a set of metrics for a particular NMME-forced
LIS forecast.  The jobs will be submitted to SLURM. The script will then wait
until all batch jobs are complete before converting files to CF-1.8 convention,
merging fields into common files, and producing GeoTIFFs.

The user will only need to execute postprocess_nmme_job.py; the other scripts
will be invoked under the hood. An example invocation to process all
NMME-forced LIS forecasts initialized at 1 Oct 2021:

/path/to/postprocess_nmme_job.py /path/to/s2smetric.cfg

run_generate_metrics.sh is a generic batch job script that accepts command line
arguments for the NMME model, forecast start year and month, configure file,
and path to a lower-level python script. It is implemented in shell (Bash) to
work best with SLURM, and is really just a wrapper for
convert_dyn_fcst_to_anom.py and convert_dyn_fcst_to_sanom.py.

convert_dyn_fcst_to_anom.py will generate anomalies for a particular
NMME-forced LIS forecast. It will look across every month of the forecast
and process several variables.

convert_dyn_fcst_to_sanom.py is similar to convert_dyn_fcst_to_anom.py, but
calculates *standardized* anomalies.

Both convert_dyn_fcst_to_anom.py and convert_dyn_fcst_to_sanom.py import
metricslib.py to make use of a common function.

convert_s2s_anom_cf.py will create a single CF-1.8 metrics file based on
a single metric file produced by convert_dyn_fcst_to_anom.py or
convert_dyn_fcst_to_sanom.py.  This script is "looped" by
postprocess_nmme_job.py.

merge_s2s_anom_cf.py will merge all the metrics for a particular NMME-forced
LIS forecast together into single CF-1.8 netCDF file.  This script is "looped"
by postprocess_nmme_job.py.

Finally, make_s2s_median_metric_geotiff.py will read the merged CF-1.8 files,
calculate medians of the metrics, and write out in GeoTIFF format.
