= Step 7: Comparison of OL and DA Experiments (LVT)

:step-label: Step 7
:download-filename: testcase7_lvt_expcomp_2023.tar.gz
:input-filesize-compressed: 481KB
:input-filesize-unpacked: 7.2MB

== Overview

In this step, you will use the Land Verification Toolkit (LVT) to compare the output generated in the open-loop (Step 2) and data assimilation (Step 6) experiments. Since LVT is a verification and validation software, you will need to plot the output using Python, Matlab, GrADS, etc. LVT offers a range of features and configuration settings so we strongly encourage users to review the link:{url-lisf-docs}[LVT Users' Guide].

// TODO: add better description of this step

include::download_input_files.adoc[]

The following files and directories were added to your common working directory `$WORKING_DIR`:

[cols="2*",frame=topbot,stripes=odd]
[%autowidth]
|===
|`lvt.config.ol.da`         |The LVT config file for the OL and DA runs
|`lvt.config_smapDAobs`     |The LVT config file for the SMAP observations used in the DA run
|`METRICS.TBL`              |A text file that defines the statistical metric options used by LVT
|`TS_LOCATIONS.TXT`         |A text file that specifies the points or regions in the domain where ASCII time series data are to be derived
|`target_STATS.ol.da/`      |A directory containing the target LVT output for the OL and DA runs
|`target_STATS.smapDAobs/`  |A directory containing the target LVT output for the SMAP DA obs run
|`target_log/`              |A directory containing target log files
|`target_fig/`              |A directory containing target figures
|`plot_TS.m`                |A Matlab script to generate plots of the output
|`plot_noah36_smapda_littlewashita.plt`
 `plot_noah36_smapda_fortcobb.plt`      |`gnuplot` scripts to generate plots of the output
|===

== The LVT Configuration Files

Review the two LVT configuration files for this step.

.`lvt.config.ol.da`:
[source,shell]
----
#Overall driver options
LVT running mode:                       "Data intercomparison"
Map projection of the LVT analysis:     latlon
LVT output format:                      netcdf
LVT output methodology:                 "2d gridspace"

Analysis data sources:               "LIS output"  "LIS output"
...

#     Datastream 1             |            Datastream 2
LVT datastream attributes table::
SoilMoist  1 1  m3/m3   - 1 4     SoilMoist  1 1  m3/m3    - 1 4
RootMoist  1 1  m3/m3   - 1 1     RootMoist  1  1 m3/m3    - 1 1
...
----

.`lvt.config.smapDAobs`:
[source,shell]
----
#Overall driver options
LVT running mode:                       "Data intercomparison"
Map projection of the LVT analysis:     latlon
LVT output format:                      netcdf
LVT output methodology:                 "2d gridspace"

Analysis data sources:                  "LIS DAOBS"  "none"
...

## DATA STREAM INPUTS ....

#Observation
LIS DAOBS output directory:  ./SMAPDA_OUTPUT/DAOBS
LIS DAOBS domain file:       ./lis_input.nldas.noah36.d01.nc
LIS DAOBS instance index:     1
LIS DAOBS use scaled obs:     1
LIS DAOBS output interval:    "15mn"
LIS DAOBS observation type:   "soil moisture"
...
----

== Running LVT

First, run LVT to process the OL vs. DA soil moisture output:

[source,shell]
----
% ./LVT lvt.config.ol.da
----

If the run fails, troubleshoot the issue by reviewing any errors printed to the terminal and by viewing the contents of any log files present (e.g., `lvtlog*.0000`). Otherwise, verify that the run completed successfully by checking for the confirmation message at the end of `lvtlog_ol_da.0000`:

[source,shell]
----
% tail lvtlog_ol_da.0000
...
[INFO] Finished LVT analysis
 [INFO] --------------------------------------
----

The output generated by this run can be found in the `STATS.ol.da` directory and should include point data for "Fort Cobb" and "Little Washita", locations specified in the `TS_LOCATIONS.txt` file. Compare these files with the target output in `target_STATS.ol.da` using `nccmp` to compare the NetCDF files and `diff` to compare the `.dat` files.

Next, run LVT to process the SMAP DA observations so it can be easily compared with our model output:

[source,shell]
----
% ./LVT lvt.config.smapDAobs
----

If the run fails, troubleshoot the issue by reviewing any errors printed to the terminal and by viewing the contents of any log files present (e.g., `lvtlog*.0000`). Otherwise, verify that the run completed successfully by checking for the confirmation message at the end of `lvtlog.smapDAobs.0000`:

[source,shell]
----
% tail lvtlog.smapDAobs.0000
...
[INFO] Finished LVT analysis
 [INFO] --------------------------------------
----

The output generated by this run can be found in the `STATS.smapDAobs` directory and should include point data for "Fort Cobb" and "Little Washita", locations specified in the `TS_LOCATIONS.TXT` file. Again, compare these files with the target output in `target_STATS.smapDAobs` using `nccmp` to compare the NetCDF files and `diff` to compare the `.dat` files.

== Plot the Results

We can now compare the results of our OL and DA runs with the observations we assimilated. Sample scripts to generate plots with `gnuplot` (`plot_noah36_smapda_*.plt`) and Matlab (`plot_TS.m`) are included among the input files.

[IMPORTANT]
====
The `gnuplot` and Matlab scrips mentioned above expect the existence of a `$WORKING_DIR/fig` directory as a location to save figures. The scripts will not automatically make this directory. Therefore, prior to running these scripts, you must manually create a `$WORKING_DIR/fig` directory.
====

=== `gnuplot` Plots

image::step_7_noah36_ol_da_littlewashita.png[align="center"]

image::step_7_noah36_ol_da_fortcobb.png[align="center"]

=== Matlab Plots

image::step_7_OL_DA_Little_Washita.png[align="center"]

image::step_7_OL_DA_Fort_Cobb.png[align="center"]

== Wrap Up

You have now completed the end-to-end public testcase for NASA's Land Information System.
