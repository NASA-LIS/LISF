= Step 6: LSM Data Assimilation (DA) Experiment (LIS)

:step-label: Step 6
:download-filename: testcase6_lis_da_2023.tar.gz
:input-filesize-compressed: 80MB
:input-filesize-unpacked: 327MB

== Overview

The *Data Assimilation (DA) subsystem* in LIS is primarily used for state estimation (i.e., correction of model states based on observations) and supports the interoperable use of multiple land surface models, algorithms, and observational data sources. The DA subsystem also provides support for concurrent data assimilation, forward models, radiance assimilation, and observation operators employing advanced data fusion methods (i.e., deep learning). Advanced data assimilation algorithms such as _Ensemble Kalman Filter (EnKF)_ and _Ensemble Kalman Smoother (EnKS)_ are available.

image::step_6_interoperability_fig.png[pdfwidth=50%,align="center"]

[NOTE]
====
For more information:

Kumar, S. V., R. H. Reichle, C. D. Peters-Lidard, R. D. Koster, X. Zhan, W. T. Crow, J. B. Eylander, and P. R. Houser, 2008: A Land Surface Data Assimilation Framework using the Land Information System: Description and Applications, _Adv. Wat. Res._, 31, 1419-1432, link:https://www.sciencedirect.com/science/article/abs/pii/S0309170808000146[doi:10.1016/j.advwatres.2008.01.013].
====

The DA subsystem outputs a number of diagnostics including:

* DA innovations, normalized innovations, and ensemble spread
* Processed/bias-corrected/quality-controlled (QC'd) observational data

The Land Verification Toolkit (LVT) handles automated processing of these outputs.

.Example DA output: variance of normalized innovations
image::step_6_innovations_var_fig.png[width=350px,align="center"]

include::download_input_files.adoc[]

The following directories and files were added to your common working directory `$WORKING_DIR`:

[cols="2*",frame=topbot,stripes=odd]
[%autowidth]
|===
|`DA_INPUT/`                    |Contains the perturbation files used in the DA run
|`lis.config_noah36_smapda`     |The LIS config file for this step
|`target_SMAPDA_OUTPUT/`        |Contains the target DA output generated by LIS
|`target_log/lislog_smapda.0000`|The target LIS log file
|`target_da.xdf` & `test_da.xdf`|GrADS description files to view the output
|===

[IMPORTANT]
====
This step relies on files downloaded or generated in the previous steps. In addition to the files just downloaded, ensure the following directories are present in `$WORKING_DIR`:

[cols="2*",frame=topbot,stripes=odd]
[%autowidth]
|===
|`DA_ensrst/`    |Ensemble restart files generated in Step 3 
|`DA_proc_LSM/`  |LSM-based CDF files generated in Step 4
|`DA_proc_SMAP/` |Observations-based CDF files generated in Step 5
|`RS_DATA/`      |Observation data files downloaded in Step 5
|`INPUT/`        |NLDAS2 forcing and Noah model files downloaded in Step 2
|===
====

== The LIS Configuration File

Review the contents of `lis.config_noah36_smapda` to view the configuration settings used for the DA run:

.Restart options:
[source,shell]
----
...
Start mode:                                restart <1>
...
Number of ensembles per tile:              12 <2>
...
Noah.3.6 restart file:                    ./DA_ensrst/LIS_EnRST_NOAH36_201801010000.d01.nc <3>
...
----
<1> Select "restart" mode to use a restart file (as opposed to "coldstart" mode).
<2> # of ensemble members to use (matches ensemble restart file).
<3> Filepath of the 12 member ensemble restart file generated in Step 3.

.Data assimilation options:
[source,shell]
----
...
Number of data assimilation instances:               1

Data assimilation algorithm:                         "EnKF"
Data assimilation set:                               "SMAP(NASA) soil moisture"  
Number of state variables:                           4 
Data assimilation use a trained forward model:       0
Data assimilation trained forward model output file: none
Data assimilation exclude analysis increments:       0
Data assimilation output interval for diagnostics:  "1da"
Data assimilation number of observation types:       1
Data assimilation output ensemble spread:            1
Data assimilation output processed observations:     1
Data assimilation output innovations:                1
...
----

.Scaling strategy options:
[source,shell]
----
...
Data assimilation scaling strategy:         "CDF matching"
Data assimilation observation domain file:  ./lis_input.nldas.noah36.d01.nc

Bias estimation algorithm:                  "none"
Bias estimation attributes file:            "none"
Bias estimation restart output frequency:
Bias estimation start mode:
Bias estimation restart file:
...
----

.Perturbation options:
[source,shell]
----
...
Perturbations start mode:                 "coldstart"
Perturbations restart output interval:    "1mo" 
Perturbations restart filename:           "none"
Apply perturbation bias correction:       0
...
Forcing perturbation algorithm:           "GMAO scheme" <1>
Forcing perturbation frequency:           "1hr" 
Forcing attributes file:                  ./DA_INPUT/forcing_attribs.txt
Forcing perturbation attributes file:     ./DA_INPUT/forcing_pert_attribs.txt

State perturbation algorithm:             "GMAO scheme" <2>
State perturbation frequency:             "6hr"
State attributes file:                    ./DA_INPUT/noah_sm_attribs.txt
State perturbation attributes file:       ./DA_INPUT/noah_sm_pertattribs.txt

Observation perturbation algorithm:       "GMAO scheme" <3>
Observation perturbation frequency:       "6hr"
Observation attributes file:              ./DA_INPUT/smap_attribs.txt
Observation perturbation attributes file: ./DA_INPUT/smap_pertattribs.txt
----
<1> Forcing perturbation options
<2> State perturbation options
<3> Observation perturbation options

.Observation data options:
[source,shell]
----
SMAP(NASA) soil moisture data designation:       SPL3SMP
SMAP(NASA) soil moisture data directory:        ./RS_DATA/SMAP/SPL3SMP.005
SMAP(NASA) soil moisture use scaled standard deviation model: 0
SMAP(NASA) soil moisture apply SMAP QC flags:                 1
SMAP(NASA) model CDF file:              ./DA_proc_LSM/cdf_noah36.nc
SMAP(NASA) observation CDF file:        ./DA_proc_SMAP/cdf_smapobs.nc
SMAP(NASA) soil moisture number of bins in the CDF:          100
SMAP(NASA) CDF read option: 0
SMAP(NASA) soil moisture use scaled standard deviation model: 0
SMAP(NASA) soil moisture Composite Release ID: R16
----

See the link:{url-lisf-docs}[LIS Users' Guide] for more information about configuration settings.

== The Perturbation Configuration Files

=== Forcing Perturbations

Forcing variables and perturbation settings are defined in the files named `forcing_attribs.txt` and `forcing_pert_attribs.txt`, respectively. The paths to these files are set in the LIS configuration file (see _Forcing perturbation options_ annotation above).

.`forcing_attribs.txt` specifies the variables and their ranges:
[source,shell]
----
#nfields
4
#varmin  varmax 
Incident Shortwave Radiation Level 001
0.       1300.
Incident Longwave Radiation Level 001
-50.     800.
Rainfall Rate Level 001
0.0      0.001
Near Surface Air Temperature Level 001
220.0    330.0
----

For each variable listed in the snippet above, the name is given followed by the min and max values.

.`forcing_pert_attribs.txt` specifies perturbation settings:
[source,shell]
----
#ptype   std    std_max   zeromean  tcorr  xcorr ycorr ccorr 
Incident Shortwave Radiation Level 001
1        0.20   2.5       1         86400  0     0     1.0  -0.3 -0.5  0.3
Incident Longwave Radiation Level 001
0        30.0   2.5       1         86400  0     0    -0.3   1.0  0.5  0.6
Rainfall Rate Level 001
1        0.50   2.5       1         86400  0     0    -0.5   0.5  1.0  -0.1
Near Surface Air Temperature Level 001
0        0.5    2.5       1         86400  0     0     0.3   0.6  -0.1  1.0
----

In the snippet above, the column headings represent:

* `ptype`: Perturbation type; additive (0) or multiplicative (1)
* `std`: Standard deviation of perturbations
* `std_max`: Maximum allowed normalized perturbation relative to _N(0, 1)_
* `zeromean`: Enforce zero mean across the ensemble; off (0) or on (1)
* `tcorr`: Temporal correlation scale (in seconds) used in the AR(1) model
* `xcorr` &  `ycorr`: Spatial correlation scale (deg)
* `ccorr`: Cross-correlations with other variables

=== State Perturbations

State variables and perturbation settings are defined in the files named `noah_sm_attribs.txt` and `noah_sm_pertattribs.txt`, respectively. The paths to these files are set in the LIS configuration file (see _State perturbation options_ annotation above).

.`noah_sm_attribs.txt` specifies perturbation settings:
[source,shell]
----
#nfields
4
#varmin  varmax	 
Soil Moisture Layer 1
 0.01    0.55   
Soil Moisture Layer 2
 0.01    0.55	
Soil Moisture Layer 3
 0.01    0.55	
Soil Moisture Layer 4
 0.01    0.55	
----

.`noah_sm_pertattribs.txt` specifies the variables and their ranges:
[source,shell]
----
#perttype  std    std_max   zeromean  tcorr    xcorr ycorr ccorr
Soil Moisture Layer 1
  0        0.02   0.1       1          10800   0     0     1.0 0.0 0.0 0.0
Soil Moisture Layer 2
  0        0.00   0.1       1          10800   0     0     0.0 1.0 0.0 0.0
Soil Moisture Layer 3
  0        0.00   0.1       1          10800   0     0     0.0 0.0 1.0 0.0
Soil Moisture Layer 4
  0        0.00   0.1       1          10800   0     0     0.0 0.0 0.0 1.0
----

=== Observation Perturbations

Observation variables and perturbation settings are defined in the files named `smap_attribs.txt` and `smap_pertattribs.txt`, respectively. The paths to these files are set in the LIS configuration file (see _Observation perturbation options_ annotation above).


.`smap_attribs.txt` specifies perturbation settings:
[source,shell]
----
#nfields
1
#varmin  varmax
SMOPS soil moisture
 0.01    1.0
----

.`smap_pertattribs.txt` specifies the variables and their ranges:
[source,shell]
----
#perttype std  std_max  zeromean  tcorr  xcorr ycorr ccorr
SMOPS soil moisture
 0        0.04 2.5      1         43200  0     0     1.0
----

== Run LIS - SMAP DA Experiment

You're now ready to run LIS to perform the SMAP DA experiment. From `$WORKING_DIR`, run the LIS executable with the config file for this step:

[source,shell]
----
./LIS -f lis.config_noah36_smapda
----

Using one processor, as we are here, the run will take approximately 30 minutes to complete. If the run fails, troubleshoot the issue by reviewing any errors printed to the terminal and by viewing the contents of `log/lislog_smapda.0000`. If no errors print to the terminal, verify that the run completed successfully by checking for the following confirmation at the end of `log/lislog_smapda.0000`:

[source,shell]
----
% tail lislog_smapda.0000
...
LIS Run completed.
----

View the output of the run using `GrADS`, `ncview`, Matlab, or other software. Compare the output generated by this run with the output of the Open-Loop case from Step 2.

// TODO: ADD VISUALIZATION OF OUTPUT

.`SoilMoist_tavg` variable in `LIS_HIST_201701010600.d01.nc`
image::step_6_output_example.png[pdfwidth=50%,align="center"]

== Wrap Up

You have completed the SMAP Data Assimilation Experiment. In Step 7, you will use the Land Verification Toolkit (LVT) to process the output of the OL and DA runs.
