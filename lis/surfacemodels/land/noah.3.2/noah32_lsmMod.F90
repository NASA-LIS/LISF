!-----------------------BEGIN NOTICE -- DO NOT EDIT-----------------------
! NASA Goddard Space Flight Center
! Land Information System Framework (LISF)
! Version 7.3
!
! Copyright (c) 2020 United States Government as represented by the
! Administrator of the National Aeronautics and Space Administration.
! All Rights Reserved.
!-------------------------END NOTICE -- DO NOT EDIT-----------------------
#include "LIS_misc.h"
module noah32_lsmMod
!BOP
!
! !MODULE: noah32_lsmMod
!
! !DESCRIPTION:
!  
! This module provides the definition of derived data type used to 
! control the operation of Noah3.2 LSM. It also provides the entry method
! for the initialization of Noah3.2-specific variables. The derived
!  data type {\tt noah3.2\_struc} includes the variables that specify
!  the runtime options and other control variables as described below:
!
! \begin{description}
!  \item[rfile]
!    name of the noah3.2 restart file
!  \item[vfile]
!    name of the static vegetation parameter table
!  \item[sfile]
!    name of the soil parameter table
!  \item[gfile]
!    name of the general parameter table
!  \item[useptf]
!    whether PTFs should be used to map soil properties
!  \item[count]
!    variable to keep track of the number of timesteps before an output
!  \item[soilscheme]
!    type of soil mapping scheme usd (1-zobler,2-statsgo)
!  \item[nslay]
!    number of soil layers
!  \item[nvegp]
!    number of static vegetation parameters in the table
!  \item[nstxts]
!    number of soil texture classes in the classification scheme
!  \item[varid]
!    NETCDF ids for variables (used for netcdf output)
!  \item[inittemp]
!    initial soil temperatures for a cold start run
!  \item[initsm]
!    initial total soil moisture for a cold start run
!  \item[initsmliq]
!    initial liquid soil moisture for a cold start run
!  \item[rstInterval]
!   restart writing interval
!  \item[zh]
!   reference height of T and q forcing
!  \item[zm]
!   reference height of u and v forcing
!  \item[forcing\_ch]
!   flag indicating whether to use aerodynamic conductance field from forcing
!  \item[lyrthk]
!   thickness of soil layers
!  \item[noah]
!   Noah3.2 LSM specific variables
! \end{description} 
!
! !REVISION HISTORY:
! Apr 2003; Sujay Kumar, Initial Code
!   8 May 2009: Sujay Kumar; additions for Noah3.1
!  27 Oct 2010: David Mocko, changes for Noah3.1 in LIS6.1
!   7 Nov 2010: David Mocko, changes for Noah3.2 in LIS6.1
!
! !USES:        
  use noah32_module

  implicit none

  PRIVATE
!-----------------------------------------------------------------------------
! !PUBLIC MEMBER FUNCTIONS:
!-----------------------------------------------------------------------------
  public :: noah32_lsm_ini
!-----------------------------------------------------------------------------
! !PUBLIC TYPES:
!-----------------------------------------------------------------------------
  public :: noah32_struc
!EOP
  type, public ::  noah32_type_dec 

     character*100              :: rfile
     character*100              :: vfile
     character*100              :: sfile
     character*100              :: gfile
     integer                    :: useptf
     integer                    :: soilscheme
     integer                    :: nslay
     integer                    :: varid(21)
     integer                    :: usedsoilmap
     integer                    :: usedrootmap
     integer                    :: fixedvegtype
     integer                    :: fixedsoiltype
     integer                    :: fixedslopetype
     real                       :: fixedtbot
     real                       :: fixedmxsnalb
     real                       :: shdfac_monthly(12)
     real                       :: albedo_monthly(12)
     real                       :: z0brd_monthly(12)
     integer                    :: iz0tlnd
     integer                    :: sfcdifoption
     real                       :: rstInterval
     real                       :: zh
     real                       :: zm
     integer                    :: forcing_ch
     integer                    :: forcing_cm
     real, allocatable              :: lyrthk(:)
     real, allocatable              :: inittemp(:)
     real, allocatable              :: initsm(:)
     real, allocatable              :: initsmliq(:)
     real                       :: initskintemp
     real                       :: initcanopywater
     real                       :: initsnowdepth
     real                       :: initsnowequiv
     real :: ztmax2
     real :: dzeta2
     real :: psih2(10001)
     real :: psim2(10001)

! these flags check to see if these parameters are set from OPTUE
! (and subsequently should not be modified)
     integer :: z0brd_upd
     integer :: lai_upd
     integer :: embrd_upd
     integer :: alb_upd
     integer :: optStartFlag

     integer          :: lucats
     real, allocatable    :: shdtbl(:)
     real, allocatable    :: nrotbl(:)
     real, allocatable    :: rstbl(:)
     real, allocatable    :: rgltbl(:)
     real, allocatable    :: hstbl(:)
     real, allocatable    :: snuptbl(:)
     real, allocatable    :: maxalb(:)
     real, allocatable    :: emissmin(:)
     real, allocatable    :: emissmax(:)
     real, allocatable    :: laimin(:)
     real, allocatable    :: laimax(:)
     real, allocatable    :: albmin(:)
     real, allocatable    :: albmax(:)
     real, allocatable    :: z0min(:)
     real, allocatable    :: z0max(:)

     integer                  :: forc_count
     real                     :: ts
     type(noah32dec), allocatable :: noah(:)
  end type noah32_type_dec

  type(noah32_type_dec), allocatable :: noah32_struc(:)
  SAVE
contains
!BOP
! 
! !ROUTINE: noah32_lsm_ini
! \label{noah32_lsm_ini}
! 
! !INTERFACE:
  subroutine noah32_lsm_ini()
! !USES:
    use LIS_coreMod,      only : LIS_rc
    use LIS_surfaceModelDataMod, only : LIS_sfmodel_struc
    use LIS_timeMgrMod,   only : LIS_clock, LIS_calendar, &
         LIS_update_timestep, LIS_registerAlarm
    use LIS_logMod,       only : LIS_verify
! !DESCRIPTION:        
!
!  This routine creates the datatypes and allocates memory for Noah3.2-specific
!  variables. It also invokes the routine to read the runtime specific options
!  for Noah3.2 from the configuration file. 
! 
!  The routines invoked are: 
!  \begin{description}
!   \item[noah32\_readcrd](\ref{noah32_readcrd}) \newline
!    reads the runtime options for Noah3.2 LSM
!  \end{description}
!EOP
    implicit none
    integer                 :: i,n,t
    character*3             :: fnest
    integer                 :: status

    allocate(noah32_struc(LIS_rc%nnest))
    call noah32_readcrd()
    do n=1,LIS_rc%nnest
       allocate(noah32_struc(n)%noah(LIS_rc%npatch(n,LIS_rc%lsm_index)))
       do i=1,LIS_rc%npatch(n,LIS_rc%lsm_index)
          allocate(noah32_struc(n)%noah(i)%stc(noah32_struc(n)%nslay))
          allocate(noah32_struc(n)%noah(i)%smc(noah32_struc(n)%nslay))
          allocate(noah32_struc(n)%noah(i)%sh2o(noah32_struc(n)%nslay))
          allocate(noah32_struc(n)%noah(i)%relsmc(noah32_struc(n)%nslay))
       enddo
       noah32_struc(n)%forc_count = 0 
       do i=1,LIS_rc%npatch(n,LIS_rc%lsm_index)
          noah32_struc(n)%noah(i)%tair = 0 
          noah32_struc(n)%noah(i)%qair = 0 
          noah32_struc(n)%noah(i)%swdown = 0 
          noah32_struc(n)%noah(i)%lwdown = 0
          noah32_struc(n)%noah(i)%uwind = 0
          noah32_struc(n)%noah(i)%vwind = 0 
          noah32_struc(n)%noah(i)%psurf = 0 
          noah32_struc(n)%noah(i)%rainf = 0 
          noah32_struc(n)%noah(i)%snowf = 0 
          noah32_struc(n)%noah(i)%rainf_c = 0 
          noah32_struc(n)%noah(i)%ch = 0 
       enddo

!------------------------------------------------------------------------
! Model timestep Alarm
!------------------------------------------------------------------------
       call LIS_update_timestep(LIS_rc, n, noah32_struc(n)%ts)
       
       write(fnest,'(i3.3)') n
       call LIS_registerAlarm("Noah32 model alarm "//trim(fnest),&
            noah32_struc(n)%ts,&
            noah32_struc(n)%ts)

       call LIS_registerAlarm("Noah32 restart alarm "//trim(fnest),&
            noah32_struc(n)%ts,&
            noah32_struc(n)%rstInterval)

       ! Initialize min/max values to implausible values.
       noah32_struc(n)%noah(:)%tair_agl_min = 999.0


       noah32_struc(n)%z0brd_upd = 0 
       noah32_struc(n)%lai_upd = 0 
       noah32_struc(n)%embrd_upd = 0 
       noah32_struc(n)%alb_upd = 0 

       noah32_struc(n)%optStartFlag = 1 
!uninitialized variables: 
       do i=1,LIS_rc%npatch(n,LIS_rc%lsm_index)
          noah32_struc(n)%noah(i)%cqs2 = LIS_rc%udef
          noah32_struc(n)%noah(i)%qsfc = LIS_rc%udef
          noah32_struc(n)%noah(i)%sca = 0.0
       enddo


       LIS_sfmodel_struc(n)%nsm_layers = noah32_struc(n)%nslay
       LIS_sfmodel_struc(n)%nst_layers = noah32_struc(n)%nslay
       allocate(LIS_sfmodel_struc(n)%lyrthk(noah32_struc(n)%nslay))
       do i = 1,noah32_struc(n)%nslay
          LIS_sfmodel_struc(n)%lyrthk(i) = noah32_struc(n)%lyrthk(i)*100.0
       enddo
       LIS_sfmodel_struc(n)%ts = noah32_struc(n)%ts

!!!!       !initialize state vars; will be overridden later if restart mode
!!!!       call noah32_coldstart(LIS_rc%lsm_index)
!!!!       ! Set initial q1 to a negative value - D. Mocko
!!!!       ! Will be set to q2 for the first timestep in noah32_main
!!!!       do i=1,LIS_rc%npatch(n,LIS_rc%lsm_index)
!!!!          noah32_struc(n)%noah(i)%q1 = -0.5
!!!!       enddo
    enddo

!moved the coldstart setting to init to help the resetting of 
! initial conditions for OPT cases (if initial conditions are part of 
! the parameteters being optimized. 
    
    call noah32_coldstart(LIS_rc%lsm_index)
     ! Set initial q1 to a negative value - D. Mocko
! Will be set to q2 for the first timestep in noah32_main
    do n=1,LIS_rc%nnest
       do t=1,LIS_rc%npatch(n,LIS_rc%lsm_index)
          noah32_struc(n)%noah(t)%q1 = -0.5
       enddo
    enddo

  end subroutine noah32_lsm_ini

end module noah32_lsmMod
